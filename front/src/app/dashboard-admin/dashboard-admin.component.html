<div class="dashboard-admin-container">
  <h1>Panel de AdministraciÃ³n</h1>

  @if (isLoading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando informaciÃ³n del sistema...</p>
    </div>
  }

  @if (error()) {
    <div class="alert alert-error">
      <p>{{ error() }}</p>
      <button (click)="cargarDashboard()" class="btn-retry">Reintentar</button>
    </div>
  }

  @if (dashboard()) {
    <!-- EstadÃ­sticas Generales -->
    <section class="estadisticas-generales">
      <h2>EstadÃ­sticas del Sistema</h2>
      <div class="stats-grid stats-grid-centrada">
        <div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-info"><h3>{{ dashboard()!.estadisticasGenerales.totalUsuarios }}</h3><p>Usuarios Totales</p><small>{{ dashboard()!.estadisticasGenerales.usuariosPendientes }} pendientes</small></div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ¢</div><div class="stat-info"><h3>{{ dashboard()!.estadisticasGenerales.totalEmpresas }}</h3><p>Empresas</p></div></div>
        <div class="stat-card"><div class="stat-icon">ğŸš—</div><div class="stat-info"><h3>{{ dashboard()!.estadisticasGenerales.totalVehiculos }}</h3><p>VehÃ­culos</p></div></div>
        <div class="stat-card"><div class="stat-icon">â°</div><div class="stat-info"><h3>{{ dashboard()!.estadisticasGenerales.subastasActivas }}</h3><p>Subastas Activas</p></div></div>
        <div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-info"><h3>{{ dashboard()!.estadisticasGenerales.subastasTerminadas }}</h3><p>Subastas Finalizadas</p></div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ“Š</div><div class="stat-info"><h3>{{ dashboard()!.estadisticasGenerales.totalSubastas }}</h3><p>Total Subastas</p></div></div>
      </div>
    </section>

    <!-- GrÃ¡ficos de EstadÃ­sticas -->
    <section class="graficos-section">
      <div class="graficos-container">
        <div class="grafico-card">
          <canvas #subastasChart></canvas>
        </div>
        <div class="grafico-card">
          <canvas #pujasChart></canvas>
        </div>
      </div>
    </section>

    <!-- Subastas Activas -->
    <section class="subastas-activas">
      <h2>Subastas Activas ({{ dashboard()!.subastasActivas.length }})</h2>
      <button (click)="exportarExcel('activas')" class="btn-exportar-excel">
        <span class="excel-icon"></span> Exportar Excel
      </button>
      
      @if (dashboard()!.subastasActivas.length === 0) {
        <p class="no-data">No hay subastas activas en este momento</p>
      } @else {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>VehÃ­culo</th>
                <th>Precio Inicial</th>
                <th>Puja Actual</th>
                <th>Ganando</th>
                <th>Total Pujas</th>
                <th>Tiempo Restante</th>
                <th>Contacto</th>
              </tr>
            </thead>
            <tbody>
              @for (subasta of dashboard()!.subastasActivas; track subasta.idSubasta) {
                <tr>
                  <td>{{ subasta.idSubasta }}</td>
                  <td>
                    <strong>{{ subasta.vehiculo.marca }} {{ subasta.vehiculo.modelo }}</strong><br>
                    <small>{{ subasta.vehiculo.anio }} - {{ subasta.vehiculo.matricula }}</small>
                  </td>
                  <td>{{ subasta.precioInicial | currency:'EUR' }}</td>
                  <td>
                    <strong>{{ subasta.precioActual || subasta.precioInicial | currency:'EUR' }}</strong>
                  </td>
                  <td>
                    @if (subasta.pujaGanadora) {
                      <div class="ganador-info">
                        <strong>{{ subasta.pujaGanadora.usuario.nombre }} {{ subasta.pujaGanadora.usuario.apellidos }}</strong><br>
                        <small>{{ subasta.pujaGanadora.cantidad | currency:'EUR' }}</small>
                      </div>
                    } @else {
                      <span class="sin-pujas">Sin pujas</span>
                    }
                  </td>
                  <td>{{ subasta.totalPujas }}</td>
                  <td>
                    <span class="tiempo-restante">{{ subasta.tiempoRestante }}</span>
                  </td>
                  <td>
                    @if (subasta.pujaGanadora) {
                      <div class="contacto-info">
                        <a href="mailto:{{ subasta.pujaGanadora.usuario.email }}">{{ subasta.pujaGanadora.usuario.email }}</a><br>
                        <a href="tel:{{ subasta.pujaGanadora.usuario.telefono }}">{{ subasta.pujaGanadora.usuario.telefono }}</a>
                      </div>
                    } @else {
                      <span>-</span>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </section>

    <!-- Subastas Terminadas -->
    <section class="subastas-terminadas">
      <h2>ğŸ Subastas Finalizadas - Contactar Ganadores</h2>
      <p class="section-description">AquÃ­ puedes ver los ganadores de cada subasta y sus datos de contacto para completar la venta</p>
      <button (click)="exportarExcel('terminadas')" class="btn-exportar-excel">
        <span class="excel-icon"></span> Exportar Excel
      </button>
      
      @if (dashboard()!.subastasTerminadas.length === 0) {
        <p class="no-data">No hay subastas finalizadas</p>
      } @else {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>VehÃ­culo</th>
                <th>Precio Inicial</th>
                <th>Precio Final</th>
                <th>Ganador</th>
                <th>Empresa</th>
                <th>Contacto</th>
                <th>Finalizada</th>
              </tr>
            </thead>
            <tbody>
              @for (subasta of dashboard()!.subastasTerminadas; track subasta.idSubasta) {
                <tr [class.sin-venta]="subasta.sinPujas">
                  <td>{{ subasta.idSubasta }}</td>
                  <td>
                    <strong>{{ subasta.vehiculo.marca }} {{ subasta.vehiculo.modelo }}</strong><br>
                    <small>{{ subasta.vehiculo.anio }} - {{ subasta.vehiculo.matricula }}</small>
                  </td>
                  <td>{{ subasta.precioInicial | currency:'EUR' }}</td>
                  <td>
                    @if (subasta.ganador) {
                      <strong class="precio-venta">{{ subasta.ganador.pujaGanadora | currency:'EUR' }}</strong>
                    } @else {
                      <span class="sin-venta-label">Sin ventas</span>
                    }
                  </td>
                  <td>
                    @if (subasta.ganador) {
                      <div class="ganador-info">
                        <strong>{{ subasta.ganador.usuario.nombre }} {{ subasta.ganador.usuario.apellidos }}</strong><br>
                        <small>ID: {{ subasta.ganador.usuario.idUsuario }}</small>
                      </div>
                    } @else {
                      <span class="sin-pujas">Sin pujas</span>
                    }
                  </td>
                  <td>
                    @if (subasta.ganador?.usuario?.empresa) {
                      <div>
                        <strong>{{ subasta.ganador!.usuario!.empresa!.nombre }}</strong><br>
                        <small>CIF: {{ subasta.ganador!.usuario!.empresa!.cif }}</small>
                      </div>
                    } @else {
                      <span>-</span>
                    }
                  </td>
                  <td>
                    @if (subasta.ganador) {
                      <div class="contacto-info">
                        <a href="mailto:{{ subasta.ganador.usuario.email }}" class="btn-contact">
                          âœ‰ï¸ {{ subasta.ganador.usuario.email }}
                        </a><br>
                        @if (subasta.ganador.usuario.telefono) {
                          <a href="tel:{{ subasta.ganador.usuario.telefono }}" class="btn-contact">
                            ğŸ“ {{ subasta.ganador.usuario.telefono }}
                          </a>
                        } @else {
                          <span class="no-phone">Sin telÃ©fono</span>
                        }
                      </div>
                    } @else {
                      <span>-</span>
                    }
                  </td>
                  <td>
                    <span class="tiempo-finalizada">{{ subasta.tiempoFinalizada }}</span>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </section>

    <!-- Enlaces RÃ¡pidos -->
    <section class="acciones-rapidas">
      <h2>Acciones RÃ¡pidas</h2>
      <div class="acciones-grid">
        <a [routerLink]="['/admin/usuarios']" class="accion-card">
          <span class="accion-icon">ğŸ‘¥</span>
          <span>Gestionar Usuarios</span>
          @if (dashboard()!.estadisticasGenerales.usuariosPendientes > 0) {
            <span class="badge">{{ dashboard()!.estadisticasGenerales.usuariosPendientes }}</span>
          }
        </a>
        <a [routerLink]="['/admin/vehiculos']" class="accion-card">
          <span class="accion-icon">ğŸš—</span>
          <span>Gestionar VehÃ­culos</span>
        </a>
        <a [routerLink]="['/admin/empresas']" class="accion-card">
          <span class="accion-icon">ğŸ¢</span>
          <span>Gestionar Empresas</span>
        </a>
        <a [routerLink]="['/admin/notificaciones']" class="accion-card">
          <span class="accion-icon">ğŸ””</span>
          <span>Notificaciones</span>
        </a>
        <!-- Exportar PDF de subastas filtradas -->
        <div class="accion-card exportar-pdf-card">
          <span class="accion-icon pdf-icon"></span>
          <span>Exportar PDF de Subastas</span>
          <div class="exportar-pdf-form">
            <label for="fechaInicio">Desde:</label>
            <input type="date" id="fechaInicio" [value]="fechaInicio" (input)="fechaInicio = $event.target.value" class="date-input" />
            <label for="fechaFin">Hasta:</label>
            <input type="date" id="fechaFin" [value]="fechaFin" (input)="fechaFin = $event.target.value" class="date-input" />
            <button (click)="exportarPDF()" class="btn-exportar-pdf">
              <span class="pdf-icon"></span> Generar PDF
            </button>
          </div>
        </div>
        <button (click)="exportarExcel('activas')" class="btn-exportar-excel">
          <span class="excel-icon"></span> Exportar Excel Activas
        </button>
        <button (click)="exportarExcel('terminadas')" class="btn-exportar-excel">
          <span class="excel-icon"></span> Exportar Excel Terminadas
        </button>
      </div>
    </section>
  }
</div>

<div class="layout-container" (click)="showNotifications && toggleNotifications()">
  <!-- Sidebar -->
  <aside class="sidebar" [class.collapsed]="!sidebarOpen">
    <div class="sidebar-header">
      <div class="logo">
        <img src="/logo.svg" alt="Logo" class="logo-image" />
        @if (sidebarOpen) {
          <span class="logo-text">Desguaces Borox</span>
        }
      </div>
      <button class="toggle-btn" (click)="toggleSidebar()" aria-label="Toggle menu">
        <span>{{ sidebarOpen ? '‚óÄ' : '‚ñ∂' }}</span>
      </button>
    </div>

    <nav class="sidebar-nav">
      @for (item of visibleMenuItems(); track item.route || item.label) {
        @if (item.submenu) {
          <div class="nav-item-group">
            <button 
              class="nav-item nav-item-parent"
              (click)="toggleSubmenu(item.label)"
              [class.active]="expandedMenus().has(item.label)"
            >
              <span class="nav-icon">{{ item.icon }}</span>
              @if (sidebarOpen) {
                <span class="nav-label">{{ item.label }}</span>
                <span class="nav-arrow">{{ expandedMenus().has(item.label) ? '‚ñº' : '‚ñ∂' }}</span>
              }
            </button>
            @if (expandedMenus().has(item.label) && sidebarOpen) {
              <div class="submenu">
                @for (subitem of item.submenu; track subitem.route) {
                  <a 
                    [routerLink]="subitem.route" 
                    [queryParams]="subitem.queryParams"
                    routerLinkActive="active"
                    class="submenu-item"
                    [title]="subitem.label"
                  >
                    <span class="nav-icon">{{ subitem.icon }}</span>
                    <span class="nav-label">{{ subitem.label }}</span>
                  </a>
                }
              </div>
            }
          </div>
        } @else {
          <a 
            [routerLink]="item.route" 
            routerLinkActive="active"
            class="nav-item"
            [title]="item.label"
          >
            <span class="nav-icon">{{ item.icon }}</span>
            @if (sidebarOpen) {
              <span class="nav-label">{{ item.label }}</span>
            }
          </a>
        }
      }
    </nav>

    <div class="sidebar-footer">
      <button class="logout-btn" (click)="logout()" [title]="sidebarOpen ? 'Cerrar Sesi√≥n' : ''">
        <span class="nav-icon">üö™</span>
        @if (sidebarOpen) {
          <span>Cerrar Sesi√≥n</span>
        }
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="header-brand">
          <svg class="header-logo" width="120" height="120" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="100" cy="100" r="85" stroke="#003049" stroke-width="3" fill="none"/>
            <g transform="translate(45, 85)">
              <path d="M 10 20 L 25 5 L 65 5 L 80 20 L 80 35 L 10 35 Z" fill="#0077b6" stroke="#003049" stroke-width="2"/>
              <rect x="28" y="10" width="18" height="12" fill="#edf2f4" stroke="#003049" stroke-width="1.5"/>
              <rect x="50" y="10" width="18" height="12" fill="#edf2f4" stroke="#003049" stroke-width="1.5"/>
              <circle cx="25" cy="35" r="8" fill="#2b2d42" stroke="#003049" stroke-width="2"/>
              <circle cx="25" cy="35" r="4" fill="#edf2f4"/>
              <circle cx="65" cy="35" r="8" fill="#2b2d42" stroke="#003049" stroke-width="2"/>
              <circle cx="65" cy="35" r="4" fill="#edf2f4"/>
              <circle cx="78" cy="25" r="2.5" fill="#ffd60a"/>
            </g>
            <g transform="translate(105, 50)">
              <rect x="0" y="25" width="4" height="35" fill="#2b2d42" stroke="#003049" stroke-width="1"/>
              <rect x="-5" y="20" width="14" height="8" rx="1" fill="#ffd60a" stroke="#003049" stroke-width="1.5"/>
              <rect x="-8" y="62" width="20" height="4" rx="1" fill="#003049"/>
            </g>
          </svg>
          <h1 class="page-title">Desguaces Borox</h1>
        </div>
        
        <div class="header-actions">
          <!-- Notificaciones -->
          <div class="notifications-container" (click)="$event.stopPropagation()">
            <button class="notification-bell" (click)="toggleNotifications()" title="Notificaciones">
              <span class="bell-icon">üîî</span>
              @if (notificationService.noLeidas() > 0) {
                <span class="badge">{{ notificationService.noLeidas() }}</span>
              }
            </button>

            @if (showNotifications) {
              <div class="notifications-dropdown" (click)="$event.stopPropagation()">
                <div class="notifications-header">
                  <h3>Notificaciones</h3>
                  @if (notificationService.noLeidas() > 0) {
                    <button class="btn-mark-read" (click)="marcarTodasLeidas()">
                      Marcar todas como le√≠das
                    </button>
                  }
                </div>

                <div class="notifications-list">
                  @if (notificationService.notificaciones().length === 0) {
                    <div class="empty-notifications">
                      <span>üì≠</span>
                      <p>No tienes notificaciones</p>
                    </div>
                  } @else {
                    @for (notif of notificationService.notificaciones(); track notif.id) {
                      <div 
                        class="notification-item"
                        [class.unread]="!notif.leida"
                        (click)="verNotificacion(notif)"
                      >
                        <div class="notif-icon">
                          @switch (notif.tipo) {
                            @case ('puja_ganada') {
                              <span>üèÜ</span>
                            }
                            @case ('puja_superada') {
                              <span>‚ö†Ô∏è</span>
                            }
                            @case ('subasta_finalizada') {
                              <span>üèÅ</span>
                            }
                            @case ('registro') {
                              <span>üë§</span>
                            }
                            @default {
                              <span>üì¢</span>
                            }
                          }
                        </div>
                        <div class="notif-content">
                          <p class="notif-message">{{ getMensajeNotificacion(notif) }}</p>
                          <span class="notif-time">{{ getTiempoTranscurrido(notif.fecha) }}</span>
                        </div>
                      </div>
                    }
                  }
                </div>
              </div>
            }
          </div>

          @if (currentUser()) {
            <a [routerLink]="['/perfil']" class="user-info">
              <div class="user-avatar">
                @if (currentUser()!.fotoPerfilBase64) {
                  <img 
                    [src]="'data:image/jpeg;base64,' + currentUser()!.fotoPerfilBase64" 
                    alt="Foto de perfil"
                    class="avatar-img">
                } @else {
                  <svg class="avatar-default-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="8" r="4" fill="currentColor"/>
                    <path d="M4 20c0-4.418 3.582-8 8-8s8 3.582 8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                }
              </div>
              <div class="user-details">
                <span class="user-name">{{ currentUser()!.email }}</span>
                <span class="user-role">
                  @if (currentUser()!.rol?.toLowerCase() === 'admin' || currentUser()!.rol?.toLowerCase() === 'administrador') {
                    Administrador
                  } @else if (currentUser()!.validado) {
                    Validado
                  } @else {
                    Pendiente de validaci√≥n
                  }
                </span>
              </div>
            </a>
          }
        </div>
      </div>
    </header>

    <!-- Page Content -->
    <main class="content">
      <router-outlet />
    </main>
  </div>

  <!-- Toast Notifications -->
  <app-toast />
</div>

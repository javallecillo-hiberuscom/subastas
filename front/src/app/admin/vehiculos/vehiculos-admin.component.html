<div class="admin-container">
  <div class="header">
    <h1>Gesti√≥n de Veh√≠culos</h1>
    @if (!showForm()) {
      <div class="header-actions">
        <input 
          type="text" 
          class="search-input"
          placeholder="Buscar por marca, modelo, matr√≠cula o color..."
          [value]="busqueda()"
          (input)="busqueda.set($any($event.target).value)"
        />
        <button class="btn-primary" (click)="nuevoVehiculo()">
          + Nuevo Veh√≠culo
        </button>
      </div>
    }
  </div>

  @if (successMessage()) {
    <div class="alert alert-success">
      <span>‚úì</span>
      <span>{{ successMessage() }}</span>
    </div>
  }

  @if (errorMessage()) {
    <div class="alert alert-error">
      <span>‚ö†Ô∏è</span>
      <span>{{ errorMessage() }}</span>
    </div>
  }

  @if (showForm()) {
    <div class="form-panel">
      <h2>{{ editingId ? 'Editar Veh√≠culo' : 'Nuevo Veh√≠culo' }}</h2>
      
      <form [formGroup]="vehiculoForm" (ngSubmit)="guardarVehiculo()">
        <div class="form-grid">
          <div class="form-group">
            <label>Matr√≠cula *</label>
            <input type="text" formControlName="matricula" placeholder="1234ABC" maxlength="7">
          </div>

          <div class="form-group">
            <label>Marca *</label>
            <input type="text" formControlName="marca" placeholder="Ej: Toyota">
          </div>

          <div class="form-group">
            <label>Modelo *</label>
            <input type="text" formControlName="modelo" placeholder="Ej: Corolla">
          </div>

          <div class="form-group">
            <label>A√±o *</label>
            <input type="number" formControlName="anio" min="1900" [max]="2025">
          </div>

          <div class="form-group">
            <label>Color *</label>
            <input type="text" formControlName="color" placeholder="Ej: Blanco">
          </div>

          <div class="form-group">
            <label>Kilometraje *</label>
            <input type="number" formControlName="kilometraje" min="0">
          </div>

          <div class="form-group">
            <label>Potencia (CV) *</label>
            <input type="number" formControlName="potencia" min="0">
          </div>

          <div class="form-group">
            <label>N¬∫ Puertas *</label>
            <select formControlName="numeroPuertas">
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>

          <div class="form-group">
            <label>Tipo Motor *</label>
            <select formControlName="tipoMotor">
              @for (tipo of tiposMotor; track tipo) {
                <option [value]="tipo">{{ tipo }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label>Carrocer√≠a *</label>
            <select formControlName="tipoCarroceria">
              @for (tipo of tiposCarroceria; track tipo) {
                <option [value]="tipo">{{ tipo }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label>Fecha Matriculaci√≥n *</label>
            <input type="date" formControlName="fechaMatriculacion">
          </div>

          <div class="form-group">
            <label>Precio Salida (‚Ç¨) *</label>
            <input type="number" formControlName="precioSalida" min="0">
          </div>

          <div class="form-group">
            <label>Valoraci√≥n Precio (‚Ç¨) *</label>
            <input type="number" formControlName="valoracionPrecio" min="0">
          </div>
        </div>

        <div class="form-group full-width">
          <label>Descripci√≥n</label>
          <textarea formControlName="descripcion" rows="4" 
                    placeholder="Descripci√≥n detallada del veh√≠culo..."></textarea>
        </div>

        @if (!editingId) {
          <div class="form-group full-width">
            <label>Im√°genes del veh√≠culo</label>
            
            <!-- √Årea de drag & drop -->
            <div 
              class="dropzone"
              [class.dragging]="isDragging()"
              (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event)"
              (click)="fileInput.click()">
              @if (isDragging()) {
                <div class="dropzone-content">
                  <span class="dropzone-icon">üì∑</span>
                  <p class="dropzone-text">¬°Suelta las im√°genes aqu√≠!</p>
                </div>
              } @else {
                <div class="dropzone-content">
                  <span class="dropzone-icon">üñºÔ∏è</span>
                  <p class="dropzone-text">Arrastra im√°genes aqu√≠</p>
                  <p class="dropzone-subtext">o haz click para seleccionar</p>
                </div>
              }
            </div>
            
            <input 
              type="file" 
              #fileInput
              (change)="onFileSelected($event)" 
              accept="image/*"
              multiple
              style="display: none"
            >
            
            @if (imagenesBase64().length > 0) {
              <div class="selected-files">
                <p><strong>{{ imagenesBase64().length }}</strong> imagen(es) seleccionada(s):</p>
                <div class="images-preview">
                  @for (imagen of imagenesBase64(); track imagen.nombre; let i = $index) {
                    <div class="image-preview-item">
                      <img [src]="'data:image/jpeg;base64,' + imagen.imagenBase64" [alt]="imagen.nombre">
                      <button type="button" class="btn-remove" (click)="removeFile(i)">√ó</button>
                      <span class="image-name">{{ imagen.nombre }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="form-group full-width">
            <label>Im√°genes actuales del veh√≠culo</label>
            @if (imagenesBase64().length > 0) {
              <div class="images-preview">
                @for (imagen of imagenesBase64(); track imagen.idImagen; let i = $index) {
                  <div class="image-preview-item">
                    <img [src]="imagen.imagenBase64 ? 'data:image/jpeg;base64,' + imagen.imagenBase64 : imagen.ruta || ''" [alt]="imagen.nombre">
                    <button type="button" class="btn-remove" (click)="removeFile(i)">√ó</button>
                    <span class="image-name">{{ imagen.nombre }}</span>
                  </div>
                }
              </div>
            } @else {
              <p class="no-images">No hay im√°genes</p>
            }
            
            <input 
              type="file" 
              #fileInputEdit
              (change)="onFileSelected($event)" 
              accept="image/*"
              multiple
              style="display: none"
            >
            <button type="button" class="btn-upload" (click)="fileInputEdit.click()">
              <span>üì∑</span>
              <span>Agregar m√°s Im√°genes</span>
            </button>
          </div>
        }

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="cancelar()">
            Cancelar
          </button>
          <button type="submit" class="btn-primary" [disabled]="vehiculoForm.invalid">
            {{ editingId ? 'Actualizar' : 'Crear' }} Veh√≠culo
          </button>
        </div>
      </form>
    </div>
  }

  <div class="table-container">
    @if (loading()) {
      <p class="loading">Cargando veh√≠culos...</p>
    } @else if (vehiculos().length === 0) {
      <p class="empty">No hay veh√≠culos registrados</p>
    } @else {
      <table>
        <thead>
          <tr>
            <th>Matr√≠cula</th>
            <th>Marca/Modelo</th>
            <th>A√±o</th>
            <th>Kilometraje</th>
            <th>Precio Salida</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (vehiculo of vehiculosFiltrados(); track vehiculo.idVehiculo) {
            <tr>
              <td><strong>{{ vehiculo.matricula }}</strong></td>
              <td>{{ vehiculo.marca }} {{ vehiculo.modelo }}</td>
              <td>{{ vehiculo.anio }}</td>
              <td>{{ (vehiculo.kilometraje || 0).toLocaleString() }} km</td>
              <td>{{ (vehiculo.precioSalida || 0).toLocaleString() }} ‚Ç¨</td>
              <td>
                <span class="badge" [class.vendido]="vehiculo.estaVendido">
                  {{ vehiculo.estaVendido ? 'Vendido' : 'Disponible' }}
                </span>
              </td>
              <td>
                <div class="actions">
                  <button class="btn-icon" (click)="editarVehiculo(vehiculo)" title="Editar">
                    ‚úèÔ∏è
                  </button>
                  <button class="btn-icon danger" (click)="eliminarVehiculo(vehiculo.idVehiculo)" title="Eliminar">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    }
  </div>
</div>
